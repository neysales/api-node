version: '3.8'

services:
  api:
    image: agendero/api-agendero:latest
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true
        - traefik.http.routers.agendaapi.rule=Host(`agendaapi.agendero.com`)
        - traefik.http.services.agendaapi.loadbalancer.server.port=3001
        - traefik.http.routers.agendaapi.service=agendaapi
        - traefik.http.routers.agendaapi.entrypoints=websecure
        - traefik.http.routers.agendaapi.tls.certresolver=letsencryptresolver
        - traefik.http.routers.agendaapi.tls=true
        - traefik.http.middlewares.agendaapi-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS
        - traefik.http.middlewares.agendaapi-cors.headers.accesscontrolallowheaders=*
        - traefik.http.middlewares.agendaapi-cors.headers.accesscontrolalloworiginlist=*
        - traefik.http.routers.agendaapi.middlewares=agendaapi-cors
    environment:
      - ConnectionStrings__PostgresConnection=Host=postgres_postgres;Database=agenda;Username=postgres;Password=984011c5ca123ee9060092a2af946367
      - Authentication__ApiKey=446AE6DD89E64F7F9D8964B595035644
      - NODE_ENV=production
      - DEBUG=express:*
    volumes:
      - agendero_logs:/app/logs
    networks:
      - AgenderoNet

volumes:
  agendero_logs:
    name: agendero_logs

networks:
  AgenderoNet:
    external: true
